<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="loading.css">
    <title>Monocoque-Ruby(mqrb) - Demo</title>
</head>

<body>
    <div class="loader" style="display: none"></div>
    <div id="test123">
        BLOCK
    </div>

    <script src="mqrb-core.js"></script>
    <script>
        var module;
        var dom_loader = document.getElementsByClassName("loader")[0];
        var loaded = false;

        setTimeout(() => {
            if (!loaded) {
                dom_loader.style.display = "block";
            }
        }, 1500);

        fetch('demo.mrb')
            .then(responce => responce.arrayBuffer())
            .then(buffer => new Uint8Array(buffer))
            .then(mrbByteCode => {
                fetch('mqrb-core.wasm')
                    .then(response => response.arrayBuffer())
                    .then(buffer => new Uint8Array(buffer))
                    .then(binary => {
                        var moduleArgs = {
                            wasmBinary: binary,
                            onRuntimeInitialized: function () {
                                loaded = true;
                                var mqrb_exec_mruby_irep = module.cwrap('mqrb_exec_mruby_irep', null, ['array', 'number']);
                                //var mqrb_exec_mruby_script = module.cwrap('mqrb_exec_mruby_script', null, ['string', 'number']);
                                // var s = "p Time.now; p Class.class"

                                mqrb_exec_mruby_irep(mrbByteCode, mrbByteCode.length);
                                //console.log(mqrb_exec_mruby_script(s, s.length));
                                dom_loader.style.display = "none";
                            }
                        };
                        module = Module(moduleArgs);
                    });
            });
    </script>
</body>

</html>